<section class="board-controls">
  <div class="board-controls__project">
    <p class="controls-label">Active project</p>
    <nz-select
      class="w-full"
      [ngModel]="selectedProjectId()"
      (ngModelChange)="changeProject($event)"
      nzPlaceHolder="Selecciona un proyecto"
    >
      @for (project of projects(); track project.id) {
        <nz-option [nzValue]="project.id" [nzLabel]="project.name"></nz-option>
      }
    </nz-select>

    <button nz-button nzType="default" type="button" (click)="toggleProjectForm()" class="w-full">
      {{ showProjectForm ? 'Cancelar proyecto' : 'Nuevo proyecto' }}
    </button>
  </div>

  <form [formGroup]="taskForm" (ngSubmit)="submitTask()" class="board-controls__task-form">
    <div class="controls-label">Quick add task</div>
    <div class="quick-add-row">
      <span class="material-symbols-outlined quick-add-icon">add_task</span>
      <input
        nz-input
        class="quick-add-input"
        placeholder="Task name (e.g. Implement OIDC flow)..."
        formControlName="title"
        maxlength="120"
        [disabled]="!selectedProjectId()"
      />
      <button nz-button nzType="primary" class="quick-add-button" [disabled]="!selectedProjectId()">Create</button>
    </div>

    <textarea
      nz-input
      rows="2"
      placeholder="Descripcion opcional para la issue"
      formControlName="description"
      maxlength="20000"
      [disabled]="!selectedProjectId()"
    ></textarea>
  </form>
</section>

@if (showProjectForm) {
  <section class="surface-panel mb-4 p-4">
    <div class="mb-3">
      <p class="text-[10px] font-extrabold uppercase tracking-[0.18em] text-slate-400">Create project</p>
      <h3 class="m-0 text-sm font-bold text-slate-700">Vincular repositorio GitHub</h3>
    </div>

    <form nz-form nzLayout="vertical" [formGroup]="projectForm" (ngSubmit)="submitProject()" class="grid gap-3 md:grid-cols-2">
      <nz-form-item>
        <nz-form-label nzFor="projectName">Nombre</nz-form-label>
        <nz-form-control nzErrorTip="Nombre obligatorio">
          <input id="projectName" nz-input formControlName="name" maxlength="150" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="repoOwner">Repo owner</nz-form-label>
        <nz-form-control nzErrorTip="Repo owner obligatorio">
          <input id="repoOwner" nz-input formControlName="repoOwner" maxlength="100" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="repoName">Repo name</nz-form-label>
        <nz-form-control nzErrorTip="Repo name obligatorio">
          <input id="repoName" nz-input formControlName="repoName" maxlength="100" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="token">GitHub token</nz-form-label>
        <nz-form-control nzErrorTip="Token obligatorio">
          <input id="token" nz-input type="password" formControlName="gitHubToken" maxlength="4000" />
        </nz-form-control>
      </nz-form-item>

      <div class="md:col-span-2">
        <button nz-button nzType="primary">Crear proyecto</button>
      </div>
    </form>
  </section>
}

<nz-spin [nzSpinning]="isLoading()">
  <section class="kanban-grid" cdkDropListGroup>
    <article class="kanban-column">
      <header class="kanban-column__header">
        <div class="kanban-column__title-row">
          <span class="kanban-dot"></span>
          <h2 class="kanban-column__title">To Do</h2>
          <span class="kanban-count">{{ todoTasks().length }}</span>
        </div>
        <button type="button" class="column-menu" aria-label="More options">
          <span class="material-symbols-outlined">more_horiz</span>
        </button>
      </header>

      <div
        class="kanban-list"
        cdkDropList
        [id]="todoListId"
        [cdkDropListConnectedTo]="connectedDropLists"
        [cdkDropListData]="todoTasks()"
        (cdkDropListDropped)="drop($event, 'Todo')"
      >
        @if (todoTasks().length === 0) {
          <div class="kanban-empty">Drop here</div>
        }

        @for (task of todoTasks(); track task.id) {
          <div cdkDrag [cdkDragData]="task" class="kanban-drag-item">
            <app-task-card [task]="task" [labels]="taskLabels(task.id)" (open)="openIssueDetails(task)"></app-task-card>
          </div>
        }
      </div>
    </article>

    <article class="kanban-column">
      <header class="kanban-column__header">
        <div class="kanban-column__title-row">
          <span class="kanban-dot kanban-dot--active"></span>
          <h2 class="kanban-column__title">In Progress</h2>
          <span class="kanban-count kanban-count--active">{{ inProgressTasks().length }}</span>
        </div>
        <button type="button" class="column-menu" aria-label="More options">
          <span class="material-symbols-outlined">more_horiz</span>
        </button>
      </header>

      <div
        class="kanban-list"
        cdkDropList
        [id]="inProgressListId"
        [cdkDropListConnectedTo]="connectedDropLists"
        [cdkDropListData]="inProgressTasks()"
        (cdkDropListDropped)="drop($event, 'InProgress')"
      >
        @if (inProgressTasks().length === 0) {
          <div class="kanban-empty">Drop here</div>
        }

        @for (task of inProgressTasks(); track task.id) {
          <div cdkDrag [cdkDragData]="task" class="kanban-drag-item">
            <app-task-card [task]="task" [labels]="taskLabels(task.id)" (open)="openIssueDetails(task)"></app-task-card>
          </div>
        }
      </div>
    </article>

    <article class="kanban-column">
      <header class="kanban-column__header">
        <div class="kanban-column__title-row">
          <span class="kanban-dot kanban-dot--done"></span>
          <h2 class="kanban-column__title">Done</h2>
          <span class="kanban-count kanban-count--done">{{ doneTasks().length }}</span>
        </div>
        <button type="button" class="column-menu" aria-label="More options">
          <span class="material-symbols-outlined">more_horiz</span>
        </button>
      </header>

      <div
        class="kanban-list"
        cdkDropList
        [id]="doneListId"
        [cdkDropListConnectedTo]="connectedDropLists"
        [cdkDropListData]="doneTasks()"
        (cdkDropListDropped)="drop($event, 'Done')"
      >
        @if (doneTasks().length === 0) {
          <div class="kanban-empty">Drop here</div>
        }

        @for (task of doneTasks(); track task.id) {
          <div cdkDrag [cdkDragData]="task" class="kanban-drag-item">
            <app-task-card [task]="task" [labels]="taskLabels(task.id)" (open)="openIssueDetails(task)"></app-task-card>
          </div>
        }
      </div>
    </article>
  </section>
</nz-spin>

<nz-drawer
  [nzVisible]="issueDrawerOpen()"
  nzTitle="Detalles de GitHub Issue"
  nzPlacement="right"
  [nzWidth]="520"
  [nzBodyStyle]="{ padding: '20px' }"
  (nzOnClose)="closeIssueDetails()"
>
  <ng-container *nzDrawerContent>
    @if (selectedTask()) {
      <section class="issue-head">
        <div class="flex items-center justify-between gap-2">
          @if (selectedTask()?.status === 'Todo') {
            <span class="issue-state issue-state--todo">Todo</span>
          }
          @if (selectedTask()?.status === 'InProgress') {
            <span class="issue-state issue-state--progress">In Progress</span>
          }
          @if (selectedTask()?.status === 'Done') {
            <span class="issue-state issue-state--done">Done</span>
          }
        </div>

        @if (issueDetails(); as details) {
          <h3 class="issue-title">{{ details.title }}</h3>
          <div class="issue-meta-line">
            <span class="font-mono">#{{ details.issueNumber }}</span>
            @if (details.url) {
              <a [href]="details.url" target="_blank" rel="noopener" class="issue-link">Ver en GitHub</a>
            }
          </div>
        } @else {
          <h3 class="issue-title">{{ selectedTask()?.title }}</h3>
        }
      </section>

      <div class="issue-drawer-tabs mb-4 flex gap-2">
        <button class="issue-tab" [class.issue-tab--active]="activeIssueTab() === 'summary'" (click)="setIssueTab('summary')">
          Resumen
        </button>
        <button class="issue-tab" [class.issue-tab--active]="activeIssueTab() === 'meta'" (click)="setIssueTab('meta')">
          Labels y Assignees
        </button>
        <button class="issue-tab" [class.issue-tab--active]="activeIssueTab() === 'comments'" (click)="setIssueTab('comments')">
          Comentarios
        </button>
      </div>

      @if (activeIssueTab() === 'summary') {
        <nz-spin [nzSpinning]="issueDetailsLoading()">
          @if (issueDetails(); as details) {
            <section class="issue-block">
              <div class="mb-2 flex items-center justify-between gap-2">
                <p class="issue-block-title m-0">Estado del issue</p>
                <nz-tag [nzColor]="details.state === 'open' ? 'blue' : 'green'">{{ details.state }}</nz-tag>
              </div>

              <div class="text-sm text-slate-700">
                @if (hasIssueDescription()) {
                  <p class="whitespace-pre-wrap">{{ details.description }}</p>
                } @else {
                  <p class="text-slate-400">Sin descripcion.</p>
                }
              </div>
            </section>
          } @else if (hasIssueDetailsError()) {
            <p class="text-sm text-rose-500">{{ issueDetailsError() }}</p>
          } @else {
            <p class="text-sm text-slate-500">Selecciona una tarea para ver detalle.</p>
          }
        </nz-spin>
      }

      @if (activeIssueTab() === 'meta') {
        <nz-spin [nzSpinning]="issueDetailsLoading()">
          @if (issueDetails(); as details) {
            <section class="space-y-4">
              <div class="issue-block">
                <p class="issue-block-title">Labels</p>
                <div class="flex flex-wrap gap-2">
                  @if (details.labels.length === 0) {
                    <span class="text-sm text-slate-400">Sin labels</span>
                  }
                  @for (label of details.labels; track label.name) {
                    <nz-tag [ngStyle]="issueLabelStyle(label.color)">{{ label.name }}</nz-tag>
                  }
                </div>
              </div>

              <div class="issue-block">
                <p class="issue-block-title">Assignees</p>
                <div class="flex flex-wrap items-center gap-3">
                  @if (details.assignees.length === 0) {
                    <span class="text-sm text-slate-400">Sin assignees</span>
                  }
                  @for (assignee of details.assignees; track assignee.login) {
                    <a
                      class="inline-flex items-center gap-2 text-sm text-slate-700 transition-colors hover:text-[#4a6fa5]"
                      [href]="assignee.profileUrl ?? null"
                      target="_blank"
                      rel="noopener"
                    >
                      <nz-avatar [nzSrc]="assignee.avatarUrl ?? undefined" [nzText]="assignee.login[0]"></nz-avatar>
                      <span>{{ assignee.login }}</span>
                    </a>
                  }
                </div>
              </div>
            </section>
          } @else if (hasIssueDetailsError()) {
            <p class="text-sm text-rose-500">{{ issueDetailsError() }}</p>
          } @else {
            <p class="text-sm text-slate-500">Sin datos de issue.</p>
          }
        </nz-spin>
      }

      @if (activeIssueTab() === 'comments') {
        <div class="mb-2 flex items-center justify-between">
          <p class="m-0 text-[11px] font-extrabold uppercase tracking-[0.16em] text-slate-400">Comentarios</p>
          <span class="text-xs text-slate-400">{{ issueComments().length }}</span>
        </div>

        <nz-spin [nzSpinning]="issueCommentsLoading()">
          @if (hasIssueCommentsError()) {
            <p class="text-sm text-rose-500">{{ issueCommentsError() }}</p>
          } @else if (issueComments().length === 0) {
            <nz-empty nzNotFoundContent="Sin comentarios"></nz-empty>
          } @else {
            <div class="space-y-3">
              @for (comment of issueComments(); track comment.id) {
                <article class="rounded-xl border border-slate-200 bg-slate-50/80 p-3">
                  <div class="mb-2 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2">
                      <nz-avatar
                        [nzSrc]="comment.author?.avatarUrl ?? undefined"
                        [nzText]="comment.author?.login?.[0] ?? '?'"
                      ></nz-avatar>
                      <strong class="text-sm text-slate-800">{{ comment.author?.login ?? 'unknown' }}</strong>
                    </div>
                    <span class="text-xs text-slate-400">{{ comment.createdAt | date: 'short' }}</span>
                  </div>

                  <p class="mb-0 whitespace-pre-wrap text-sm text-slate-700">{{ comment.body }}</p>
                </article>
              }
            </div>
          }
        </nz-spin>
      }
    }
  </ng-container>
</nz-drawer>
